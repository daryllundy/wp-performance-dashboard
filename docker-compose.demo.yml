services:
  demo-nginx:
    image: nginx:alpine
    ports:
      - "8090:80"
    depends_on:
      demo-wordpress:
        condition: service_healthy
    volumes:
      - ./demo/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./demo/nginx/logs:/var/log/nginx
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  demo-wordpress:
    build:
      context: .
      dockerfile: demo/wordpress/Dockerfile
    depends_on:
      demo-mysql:
        condition: service_healthy
    environment:
      - WORDPRESS_DB_HOST=demo-mysql:3306
      - WORDPRESS_DB_USER=demo_user
      - WORDPRESS_DB_PASSWORD=demo_password
      - WORDPRESS_DB_NAME=demo_wordpress
      - WORDPRESS_DEBUG=true
    volumes:
      - demo_wordpress_data:/var/www/html
      - ./demo/wordpress/wp-config-demo.php:/var/www/html/wp-config.php:ro
      - ./demo/wordpress/init-demo-content.php:/var/www/html/wp-content/mu-plugins/init-demo-content.php:ro
      - ./demo/wordpress/demo-plugins:/var/www/html/wp-content/plugins/demo-plugins:ro
      - ./demo/wordpress/uploads:/var/www/html/wp-content/uploads
    networks:
      - demo-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sS http://localhost/ -o /dev/null -w '%{http_code}' | grep -qE '^[23]' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  demo-mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=demo_root_password
      - MYSQL_DATABASE=demo_wordpress
      - MYSQL_USER=demo_user
      - MYSQL_PASSWORD=demo_password
    ports:
      - "3307:3306"
    volumes:
      - demo_mysql_data:/var/lib/mysql
      - ./demo/mysql/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./demo/mysql/performance-schema-setup.sql:/docker-entrypoint-initdb.d/02-performance-schema.sql:ro
      - ./demo/mysql/generate-performance-data.sql:/docker-entrypoint-initdb.d/03-generate-data.sql:ro
      - ./demo/mysql/my.cnf:/etc/mysql/conf.d/demo.cnf:ro
      - ./demo/mysql/logs:/var/log/mysql
    command: >
      --default-authentication-plugin=mysql_native_password
      --performance-schema=ON
      --slow-query-log=ON
      --slow-query-log-file=/var/log/mysql/slow.log
      --long-query-time=1
      --general-log=ON
      --general-log-file=/var/log/mysql/general.log
      --log-queries-not-using-indexes=ON
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "mysql", "-u", "demo_user", "-pdemo_password", "-e", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    restart: unless-stopped

  demo-data-generator:
    build:
      context: .
      dockerfile: demo/data-generator/Dockerfile
    depends_on:
      demo-mysql:
        condition: service_healthy
      demo-wordpress:
        condition: service_healthy
    environment:
      - DB_HOST=demo-mysql
      - DB_USER=demo_user
      - DB_PASSWORD=demo_password
      - DB_NAME=demo_wordpress
      - WP_URL=http://demo-wordpress
      - DEMO_DATA_SIZE=medium
    volumes:
      - ./demo/scripts:/app/scripts:ro
      - demo_generated_data:/app/data
    networks:
      - demo-network
    restart: "no"
    profiles:
      - init

  # Optional: Demo dashboard connector for testing
  demo-dashboard:
    build: .
    ports:
      - "3001:3000"
    depends_on:
      demo-mysql:
        condition: service_healthy
    environment:
      - NODE_ENV=demo
      - DB_HOST=demo-mysql
      - DB_USER=demo_user
      - DB_PASSWORD=demo_password
      - DB_NAME=demo_wordpress
      - DEMO_MODE=true
    volumes:
      - .:/app
      - /app/node_modules
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    profiles:
      - dashboard

volumes:
  demo_mysql_data:
    driver: local
  demo_wordpress_data:
    driver: local
  demo_generated_data:
    driver: local

networks:
  demo-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
